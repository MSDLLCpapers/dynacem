# Classes and methods for dynpv
# =============================

library(S7)
library(tibble)

# Define an S7 class where 'data' is a tibble

#' S7 Class Representing a Dynamic Present Value object
#' @description
#' A Dynamic Present Value object has a name and a proscribed dataset.
#' @param name Name of object (character string)
#' @param data Tibble dataset of proscribed format, such as generated by `dynamicpv::dynpv()` and `dynamicpv::futurepv()`.
#' @details
#' From these innate properties, other properties are derived:
#' - `ncoh`: Number of cohorts of uptaking patients
#' - `uptake`: Total number of uptaking patients
#' - `sum_by_coh`: Tibble of summarized calculation results for each uptake cohort
#' - `total`: Total present value
#' - `mean`: Average present value per uptaking patient (=total/uptake)
class_dynpv <- new_class(
  name = "DynPV",
  properties = list(
    # Innate properties: name and data
    name = class_character, # The 'name' property is a string
    data = class_data.frame, # The 'data' property is a data.frame - validator then requires data to be a tibble
    # Computed properties
    # Number of the cohort = length(uptakes) = max(uj)
    ncoh = new_property(
      getter = function(self) max(self@data$k)
    ),
    # Size of the cohort = sum(uptakes) = sum of uj such that k==1
    uptake = new_property(
      getter = function(self) sum(self@data$uj[self@data$k==1])
    ),
    # Sum PVs by cohort and tzero
    sum_by_coh = new_property(
      getter = function(self) {
        self@data |>
          # Summing over k, where uj does not vary by k
          dplyr::summarize(muj=mean(uj), spv = sum(pv), .by=c(j, l)) |>
          dplyr::rename(tzero = l)
      }
    ),
    # Total present value, by tzero
    total = new_property(
      getter = function(self) {
        outpv<- self@sum_by_coh |>
          dplyr::summarize(total = sum(spv), .by=c(tzero)) |>
          dplyr::select(tzero, total)
        if (nrow(outpv)==1) outpv$total else outpv
      }
    ),
    # Mean present value, by tzero - a bit duplicative of total
    mean = new_property(
      getter = function(self) {
        outpv<- self@sum_by_coh |>
          dplyr::summarize(m2uj = mean(muj), total = sum(spv), .by=c(tzero)) |>
          dplyr::mutate(mean = total/m2uj) |>
          dplyr::select(tzero, mean)
        if (nrow(outpv)==1) outpv$mean else outpv
      }
    )
  ),
  # Validation of properties
  validator = function(self) {
    if (!tibble::is_tibble(self@data)) {
      "@data must be a tibble"
    } else if (nrow(self@data) == 0) {
      "@data cannot be an empty tibble"
    }
  }
)
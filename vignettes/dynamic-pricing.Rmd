---
title: "Dynamic Pricing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Dynamic Pricing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Numeric notation in this document
# With thanks to https://stackoverflow.com/questions/18965637/set-global-thousand-separator-on-knitr/18967590#18967590
knitr::knit_hooks$set(
    inline = function(x) {
        if(!is.numeric(x)){
            x
        } else if(x<100) {
            prettyNum(round(x, 3), big.mark=",")
        } else {
            prettyNum(round(x, 0), big.mark=",")
        }
    }
)
```

## What is dynamic pricing?

Dynamic pricing is pricing of a resource (e.g. acquisition cost of a medicine, wages of a professional) that changes in time. Often, we might assume that prices are constant in real terms. In other words, were it not for price inflation, prices would be constant. This assumption provides a lot of mathematical convenience in that we can keep calculations of Net Present Value (NPV) a lot simpler.

The NPV of a cashflow $c_t$ in $t$ years time, assuming prices constant in real terms and an annual discount rate of $i_{real}$ is calculated as follows:

$$NPV = \frac{c_t}{(1+i_{real})^{t}}$$

Cashflows may not in general be expected to be constant in real terms. Accordingly it can be preferable to explicitly estimate the cashflow in nominal terms, $c'_t = c_t \cdot R_t$, and discount with a nominal discount rate that includes expected inflation.

$$ 1+i_{nom} = (1+i_{real})(1+r_g) $$
$$NPV = \frac{c'_t}{(1+i_{nom})^t} $$

## Using *dynamicpv*

First let us load the packages we will use for this vignette.

```{r setup}
library(dynamicpv)
```

### Cashflows constant in real terms

It is overkill rather to use *dynamicpv* to calculate the NPV of a cashflow that is constant in real terms, since there are simpler routes to doing this. Nevertheless, let us start there, since it helps understand functionality.

```{r demo1}
# A simple cashflow
cashflow <- c(110, 120, 130, 140, 150)

# (Real) discount rate of 3\% per timestep (year)
disc <- 0.03
vt1 <- (1 + disc)^(-1 * (0:4))

# Run dynpv calculation with full output
pv1 <- dynpv(payoffs=cashflow, discrate=disc)
pv1

# Pull out result of interest
pv1$results$total
```

The calculation can be presented in a table as follows.

| Time | Cashflow | Discount factor    | Product |
|------|----------|--------------------|---------|
| $t$  | $c_t$    | $v^t = (1+i)^{-t}$ |         |
| 1 | `r cashflow[1]` | `r vt1[1]` | `r cashflow[1] * vt1[1]` |
| 2 | `r cashflow[2]` | `r vt1[2]` | `r cashflow[2] * vt1[2]` |
| 3 | `r cashflow[3]` | `r vt1[3]` | `r cashflow[3] * vt1[3]` |
| 4 | `r cashflow[4]` | `r vt1[4]` | `r cashflow[4] * vt1[4]` |
| 5 | `r cashflow[5]` | `r vt1[5]` | `r cashflow[5] * vt1[5]` |
| Total | `r sum(cashflow)` | | `r sum(vt1 * cashflow)` | 

: Calculation of NPV from a simple cashflow and given discount rate

The present value of this cashflow is `r pv1$results$total`. The same result could have been found more easily than invoking this package.

```{r simpler}
sum(vt1 * cashflow)
```

### Cashflow escalating at constant rate

In this setting, let us assume that the cashflow escalates at a constant rate, but that this constant rate is not equal to the general price inflation one would include in a nominal discount rate. In this example, let us assume that the price of the cashflow increases at 1 \% per year, but that general price inflation is 2.5 \% per year. The real discount rate is unchanged at 3 \% per year.

First, we derive a price index to handle the changing price of the resource underlying the cashflow. Then we derive the nominal discount rate, incorporating the general rate of price inflation in the economy. We then combine these inputs with `dynamicpv::dynpv()` to calculate the NPV.

```{r calc2a}
# Set up price index
pinfl <- 0.01
pindex <- (1+pinfl)^(0:4)
pindex

# Nominal discount rate
nomdisc <- (1+disc)*1.025-1

# Calculate present value
pv2 <- dynpv(payoffs=cashflow, prices=pindex, discrate=nomdisc)
pv2$results$total
```

The NPV of `r pv2$results$total` could still have been calculated using base R functions.

```{r calc2b}
# Compare with more base calculations
vt2 <- (1+nomdisc)^(-1 * (0:4))
sum(vt2 * cashflow * pindex)
```

### Cashflow changing irregularly

Where *dynamicpv* is most relevant is when the price index is more irregular, more dynamic. For example, one might anticipate a sudden future change in a price of a certain resource (e.g. drug price reduction on loss of exclusivity). This can be accommodated in the price index. In this simple example, let us assume that the underlying price of the resource reduces to half its original value from the fourth year.

```{r calc3a}
# Revise the price index to be 0.5 from year 4
pindex[4:5] <- 0.5
pindex

# Calculate present value
pv3 <- dynpv(payoffs=cashflow, prices=pindex, discrate=nomdisc)
pv3$results$total
```

With this dynamic pricing change, the NPV has reduced by `r pv3$results$total-pv3$results$total`, from `r pv3$results$total` to `r pv3$results$total`. The corresponding base R code is shown below.

```{r calc3b}
# Compare with more base calculations
sum(vt2 * cashflow * pindex)
```

## Summary

- Dynamic pricing is when pricing of a resource changes in time. Although the examples in this vignette can be calculated with base R functions relatively easily, it is evident how calculations of NPV can quickly become complicated.
- The `dynamicpv::dynpv()` function can be used to calculate NPVs for arbitrary vectors of cashflows, at a given discount rate and a given underlying price index.
- In this way, the function can accommodate as needed irregular prices changes, regular price changes, or no price change at all.